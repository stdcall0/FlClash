name: build

on:
  push:
    branches:
        - main

concurrency:
  group: ${{ github.ref }}-${{ github.workflow }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.ACTIONS_TOKEN }}
    outputs:
      ver: ${{ steps.set-ver.outputs.version }}
      sver: ${{ steps.set-ver.outputs.sversion }}

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          submodules: recursive
      - name: Setup timezone
        uses: szenius/set-timezone@v2.0
        with:
          timezoneLinux: "Asia/Shanghai"

      - name: Setup Android Signing
        run: |
          cp $GITHUB_WORKSPACE/.github/workflows/flclash.jks $GITHUB_WORKSPACE/android/app/keystore.jks
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> android/local.properties
          echo "storePassword=${{ secrets.STORE_PASSWORD }}" >> android/local.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> android/local.properties

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.0'
          cache-dependency-path: |
            core/go.sum

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Get Flutter Dependency
        run: flutter pub get

      - name: Setup
        run: dart setup.dart android

      - id: set-ver
        shell: bash
        run: |
          ver=$(grep '^version: ' pubspec.yaml | awk '{print $2}')
          sver=$(echo "$ver" | cut -d'+' -f1)
          echo "version=$ver" >> $GITHUB_OUTPUT
          echo "sversion=$sver" >> $GITHUB_OUTPUT

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: artifact-android
          path: ./dist
          overwrite: true
